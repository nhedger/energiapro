name: Release CLI

on:
  push:
    tags:
      - "cli-v*"

permissions:
  contents: write

concurrency:
  group: release-cli-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  validate:
    name: Validate CLI release version
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Validate tag and CLI version
        id: version
        shell: bash
        run: |
          set -euo pipefail

          tag="${GITHUB_REF_NAME}"
          if [[ ! "${tag}" =~ ^cli-v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            echo "CLI release tags must match cli-vX.Y.Z. Got: ${tag}" >&2
            exit 1
          fi

          version="${tag#cli-v}"
          cli_version="$(grep -m1 '^version = ' crates/energiapro-cli/Cargo.toml | cut -d '"' -f2)"

          if [[ "${version}" != "${cli_version}" ]]; then
            echo "CLI version (${cli_version}) does not match tag (${version})." >&2
            exit 1
          fi

          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"
          echo "version=${version}" >> "${GITHUB_OUTPUT}"

  build-binaries:
    name: Build ${{ matrix.target }}
    needs: validate
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        include:
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-22.04-arm
            target: aarch64-unknown-linux-gnu
          - os: macos-15-intel
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Build CLI
        run: cargo build -p energiapro-cli --release --locked --target ${{ matrix.target }}

      - name: Prepare artifact (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail

          target="${{ matrix.target }}"
          artifact="energiapro-${target}"

          mkdir -p dist
          cp "target/${target}/release/energiapro" "dist/${artifact}"
          chmod +x "dist/${artifact}"

      - name: Prepare artifact (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $target = "${{ matrix.target }}"
          $artifact = "energiapro-$target.exe"

          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item "target/$target/release/energiapro.exe" "dist/$artifact"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.target }}
          path: dist/*
          if-no-files-found: error

  create-release:
    name: Create GitHub release
    needs:
      - validate
      - build-binaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Generate checksums
        id: checksums
        shell: bash
        run: |
          set -euo pipefail

          cd dist

          linux_x86_64_file="energiapro-x86_64-unknown-linux-gnu"
          linux_arm64_file="energiapro-aarch64-unknown-linux-gnu"
          darwin_x86_64_file="energiapro-x86_64-apple-darwin"
          darwin_arm64_file="energiapro-aarch64-apple-darwin"
          windows_file="energiapro-x86_64-pc-windows-msvc.exe"

          for file in "${linux_x86_64_file}" "${linux_arm64_file}" "${darwin_x86_64_file}" "${darwin_arm64_file}" "${windows_file}"; do
            if [[ ! -f "${file}" ]]; then
              echo "Missing expected release artifact: ${file}" >&2
              exit 1
            fi
          done

          linux_x86_64_sha256="$(sha256sum "${linux_x86_64_file}" | cut -d ' ' -f1)"
          linux_arm64_sha256="$(sha256sum "${linux_arm64_file}" | cut -d ' ' -f1)"
          darwin_x86_64_sha256="$(sha256sum "${darwin_x86_64_file}" | cut -d ' ' -f1)"
          darwin_arm64_sha256="$(sha256sum "${darwin_arm64_file}" | cut -d ' ' -f1)"
          windows_sha256="$(sha256sum "${windows_file}" | cut -d ' ' -f1)"

          {
            echo "${linux_x86_64_sha256}  ${linux_x86_64_file}"
            echo "${linux_arm64_sha256}  ${linux_arm64_file}"
            echo "${darwin_x86_64_sha256}  ${darwin_x86_64_file}"
            echo "${darwin_arm64_sha256}  ${darwin_arm64_file}"
            echo "${windows_sha256}  ${windows_file}"
          } > SHA256SUMS.txt

          {
            echo "linux_x86_64=${linux_x86_64_sha256}"
            echo "linux_arm64=${linux_arm64_sha256}"
            echo "darwin_x86_64=${darwin_x86_64_sha256}"
            echo "darwin_arm64=${darwin_arm64_sha256}"
            echo "windows_x86_64=${windows_sha256}"
          } >> "${GITHUB_OUTPUT}"

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate.outputs.tag }}
          name: ${{ needs.validate.outputs.tag }}
          generate_release_notes: true
          files: |
            dist/energiapro-x86_64-unknown-linux-gnu
            dist/energiapro-aarch64-unknown-linux-gnu
            dist/energiapro-x86_64-apple-darwin
            dist/energiapro-aarch64-apple-darwin
            dist/energiapro-x86_64-pc-windows-msvc.exe
            dist/SHA256SUMS.txt

      - name: Validate Homebrew tap SSH key
        shell: bash
        run: |
          if [[ -z "${{ secrets.HOMEBREW_TAP_SSH_KEY }}" ]]; then
            echo "HOMEBREW_TAP_SSH_KEY is not configured." >&2
            exit 1
          fi

      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HOMEBREW_TAP_SSH_KEY }}

      - name: Trust GitHub SSH host key
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Clone Homebrew tap repository
        shell: bash
        run: |
          set -euo pipefail

          rm -rf homebrew-tap
          git clone "git@github.com:nhedger/energiapro-homebrew.git" homebrew-tap

      - name: Render Homebrew formula
        shell: bash
        run: |
          set -euo pipefail

          version="${{ needs.validate.outputs.version }}"
          linux_x86_64_sha256="${{ steps.checksums.outputs.linux_x86_64 }}"
          linux_arm64_sha256="${{ steps.checksums.outputs.linux_arm64 }}"
          darwin_x86_64_sha256="${{ steps.checksums.outputs.darwin_x86_64 }}"
          darwin_arm64_sha256="${{ steps.checksums.outputs.darwin_arm64 }}"

          mkdir -p homebrew-tap/Formula

          sed \
            -e "s/{{version}}/${version}/g" \
            -e "s/{{sha256_linux_x86_64}}/${linux_x86_64_sha256}/g" \
            -e "s/{{sha256_linux_arm64}}/${linux_arm64_sha256}/g" \
            -e "s/{{sha256_darwin_x86_64}}/${darwin_x86_64_sha256}/g" \
            -e "s/{{sha256_darwin_arm64}}/${darwin_arm64_sha256}/g" \
            crates/energiapro-cli/homebrew/energiapro.rb > homebrew-tap/Formula/energiapro.rb

          if grep -q '{{' homebrew-tap/Formula/energiapro.rb; then
            echo "Homebrew formula still contains unresolved template placeholders." >&2
            exit 1
          fi

      - name: Commit Homebrew formula update
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          repository: homebrew-tap
          branch: main
          create_branch: true
          skip_fetch: true
          file_pattern: Formula/energiapro.rb
          commit_message: Update formula for ${{ needs.validate.outputs.tag }}
